# 4278 Implementar fluxo recebimento de eventos e filtragem para criação de subscription**
  
- Criar Consumidor do tópico de nome `anubis.event.lead.received` que receberá os leads do CRM. Segue sua estrutura da mensagem(sendo os ids externos do QB):
  ```json
    {
      profile_id: string | number
      product_id: string
    }
  ```
  Nota: Se mais informação for necessária relacionado a esse tópico, tente se possível solucionar olhando nas entradas e referencias fornecidas com o objetivo de fornece-las e sugeri-las usando as melhores práticas.
  
- Definir schema do `integration_filter` do tipo `qb_offer`:
  ```json
      schema: {
         university_ids: number[]
         education_group_ids: number[]
         campus_ids: number[]
         course_levels: string[]
         course_kinds: string[]
         course_shifts: string[]
         enrollment_semesters: string[]
         course_names: string[]
         campus_cities: string[]
         campus_states: string[]
         metadata: object
         required_fields: string[]
      }
  ```
  **Nota:** Fazer uso da Gem `json_schemer` para validações de schema. Nessa etapa ainda não será requerido nenhuma validação mais precisa.
  **Veja repositório como exemplo de uso:** #folder:src/payment-gateway

- Definir schema do payload da subscription
  ```json
  type SubscriptionPayload = {
      "order": {
          "base_user": {
              id: number,
              cpf: string,
              email: string,
              phone_number, string,
              gender: string,
              birth_date: string,
              full_name: string,
              rg: number,
              last_enem_score: number,
              last_enem_year: number,
              address: {
                  zipcode: string,
                  address: string,
                  address_number: string,
                  neighborhood: string,
                  city: string,
                  state: string,
              }
          },
          "offer": {
              id: number,
              uuid: number,
              discount_percentage: number,
              offered_price: number,
              university_id: number,
              metadata: object,
              educationGroupId: number | null,
              created_at: Date,
              updated_at: Date,
              course: {
                  id: number
                  name: string,
                  level: string,
                  kind: string,
                  shift: string,
                  campus: {
                      id: number,
                      name: string,
                      city: string,
                      state: string,
                      address: string,
                      address_adjunct: string,
                      address_number: string,
                      neighborhood: string,
                      zipcode: string,
                  },
                  university_offer: {
                      id: number,
                      enrollment_semester: string,
                      stock_type: string,
                      full_price: number,
                  }
              },
          }
      }
      created_at: Date,
      updated_at: Date,
      id: string,
      checkout_step: string,
      price: number
  }
  ```

- Criar os serviços `LeadEvaluationService`, `MatchService`, `LeadDataGateway` e `OrderDataGateway`, porém  não implementar lógica, apenas criar as classes com o relacionamento modelado. 
Segue suas responsabilidades(comente elas em cada respectiva classe):
- `LeadEvaluationService`: Receber `profile_id` e `product_id` e montar um subscription payload a partir do `LeadDataGateway`. Chama o `MatchService` com o payload criado para verificar a existencia de uma integração que dá match. Se houver match, cria uma subscription, se tiver interval na integration adiciona o `schedule_to`, se não manda uma mensagem para o tópico que processa as subscriptions.
- `MatchService`: Dado o payload recebido procura uma integration referente a partir do filter.
- `LeadDataGateway`: Usa o `OffersService` e o `OrderDataGateway` para construir o payload da subscription.
- `OrderDataGateway`: Constroi os dados do usuário e da ordem para o `LeadDataGateway` a partir da api do quero_bolsa.
